# activate QIIME2 environment
# you should see (qiime2-amplicon-2024.2) in front of your command prompt
mamba activate qiime2-amplicaon-2024.2

# import sequencing files into qiime 2 program and create artifact
# 4 types of seq data: 1 file w all reads (multiplex), 1 file per read, single or paired end
# our file is multiplexed single end (Earth Microbiome Protocol)
# Here's how to import all the types of data: https://docs.qiime2.org/2024.2/tutorials/importing/

# output = files it'll generate ... input-path = where on computer it can find the sequences. Within our working directory, we are saying look within emp-single-end-seq folder for our sequences
qiime tools import \
  --type EMPSingleEndSequences \
  --input-path emp-single-end-sequences \
  --output-path emp-single-end-sequences.qza

# separate all of the reads of our multiplex file. Demultiplexes.
# error correction will kick out another file for you if it corrected any errors
# within our sample-metadata.tsv file, we have a column called barcode-sequence
qiime demux emp-single \
  --i-seqs emp-single-end-sequences.qza \
  --m-barcodes-file sample-metadata.tsv \
  --m-barcodes-column barcode-sequence \
  --o-per-sample-sequences demux.qza \
  --o-error-correction-details demux-details.qza

# takes demux file and outputs visualization
qiime demux summarize \
  --i-data demux.qza \
  --o-visualization demux.qzv

# visualizes file called demux.qzv
# or go to https://view.qiime2.org/ and 
# one graph for single-end reads. two for paired-end
# the more reads the better!
#interactive quality plot represents scores the quality of seq reads. Important when you want to process high quality reads to get a good idea of what community looks like. Balance between length and quality!
qiime tools view demux.qzv
# press q to exit visualization and get command prompt back

# DADA2 and deblur do same thing
# pipeline for detecting and correcting seq. it's a qc process, eliminiating bad reads, chimaeric sequences, trims poor quality reads at 5' end and truncates 3' end

# quality control of reads based on histogram from above visualization
# Trim-left will cut at zero. cut nothing
# 3' end graph visualzation shows us 3' is bad quality, so we will truncate at 120 from 5'. It will give us 3 output files
# forward and reverse files need to be trimmed and trucated for both forward and reverse. Just add two more lines, and also say "paired"
# you can name them whatever you want
qiime dada2 denoise-single \
  --i-demultiplexed-seqs demux.qza \
  --p-trim-left 0 \
  --p-trunc-len 120 \
  --o-representative-sequences rep-seqs-dada2.qza \
  --o-table table-dada2.qza \
  --o-denoising-stats stats-dada2.qza

# tells you about your filtering process. maybe you trimmed/truncated too much. Maybe you were too stringent/conservative. If you were 
qiime metadata tabulate \
  --m-input-file stats-dada2.qza \
  --o-visualization stats-dada2.qzv

# rename files. Basically remove dada2 from names.
mv rep-seqs-dada2.qza rep-seqs.qza
mv table-dada2.qza table.qza
mv stats-dada2.qza stats.qza # rename artifact file 
mv stats-dada2.qzv stats.qzv # rename visualization file

# create visualizations for the Table and Sequences
qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table.qzv \
  --m-sample-metadata-file sample-metadata.tsv
qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs.qzv

# when we visualize table.qzv: tells us how many reads were retained for every sample. Feature Details gives code for each organism. 
# when we visualize ref-seqs.qzv: gives us actual seq. Could blast if we wanted to.
# our sample data is samples from different patient, tissue, time point

# generate a tree for phylogenetic diversity analysis
# used for alpha and beta diversity analyses. Sometimes
qiime phylogeny align-to-tree-mafft-fasttree \
  --i-sequences rep-seqs.qza \
  --o-alignment aligned-rep-seqs.qza \
  --o-masked-alignment masked-aligned-rep-seqs.qza \
  --o-tree unrooted-tree.qza \
  --o-rooted-tree rooted-tree.qza

# run alpha and beta diversity analysis. Generate alpha beta diversity numbers using a sampling depth of 1103. Gives us shannon, observed, faiths,
# Sampling depth removes some samples that aren't as diverse as we want them to be. Calculates each (1103) sample, and tells you what they are. Samples less than 1103 are excluded. We lose last three samples, as seen in our table.qzv visualization.
qiime diversity core-metrics-phylogenetic \
  --i-phylogeny rooted-tree.qza \
  --i-table table.qza \
  --p-sampling-depth 1103 \
  --m-metadata-file sample-metadata.tsv \
  --output-dir core-metrics-results


# push up to github while in qiime2 moving pictures tutorial: go up two levels to get backt o bioinformatics folder
cd ../..

#see what we need to add
git status

git add <name of file>
OR
# go to microbiome tut or github go to qiime2 moving pictures tut on github
add file > upload files > select everything but sequences (won't like anything above , drag into repository. Commit

# sync changes made on website to computer
git pull